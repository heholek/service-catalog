version: '1.0'

steps:

  CloneServices:
    title: Clone Services Repo
    type: git-clone
    repo: olegsu/openc-services
    git: cf_github
    revision: ${{CF_REVISION}}

  BuildServices:
    title: Build Services
    image: golang
    working_directory: ${{CloneServices}}
    commands:
    - rm -rf dist || true 
    - NAME=trello sh ./.scripts/build.sh
    - NAME=google-spreadsheet sh ./.scripts/build.sh
    - cf_export VERSION=$(cat VERSION)
    - echo $GOOGLE_SERVICE_ACCOUNT_B64 | base64 -D - > ${{CF_VOLUME_PATH}}/service-account.json
    - cf_export KEY_FILE_PATH=${{CF_VOLUME_PATH}}/service-account.json

  CreatingGitTag:
    title: Push tag to git
    image: codefresh/cli
    working_directory: ${{CloneServices}}    
    commands:
    - git remote rm origin
    - git remote add origin https://olegsu:${{GITHUB_TOKEN}}@github.com/olegsu/openc-services.git
    - git tag ${{VERSION}}
    - git push --tags
    fail_fast: false
    when:
      branch:
        only:
        - master

  CreateRelease:
    title: Create Release
    image: google/cloud-sdk
    working_directory: ${{CloneServices}}
    commands:
    - echo "Running script"
    - sh ./.scripts/publish.sh
    when:
      branch:
        only:
        - master